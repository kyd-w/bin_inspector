local helper = require("helper")
local h264 = require("codec_h264")

local function decode_h264(data, len)

    local ba = byte_stream(len)
    ba:set_data(data, len)

	local root = h264.decode(ba)

    local mt = bi.main_tree()
    mt:addChild(root)

    root:setExpanded(true)
--    mt:expandAll()
end

local function test_find_nalu_from_file()
--	local data = helper.read_file("/Users/tpf/vm/software/learn_go/minirtp/res/Big_Buck_Bunny_360_10s_1MB.h264")
--	local data = helper.read_file("/Users/tpf/vm/software/learn_go/minirtp/res/2001.h264")
--	decode_h264(data, len)

    helper.decode_file("/Users/tpf/vm/software/learn_go/minirtp/res/Big_Buck_Bunny_360_10s_1MB.h264")
end


local function test_find_nalu(bytes)
	local data = ""
	for _, v in ipairs(bytes) do
		--bi.log(string.format("push 0x%02X", v))
		data = data .. string.pack("B", v)
	end

	decode_h264( data, #data )
end

local bytes_sps = {
    0x00, 0x00, 0x00, 0x01, 0x67, 0x42, 0xc0, 0x1e,
    0xda, 0x02, 0x80, 0xbf, 0xe5, 0xc0, 0x5a, 0x80,
    0x80, 0x80, 0xa0, 0x00, 0x00, 0x03, 0x20, 0x00,
    0x00, 0x06, 0x01, 0xe2, 0xc5, 0xd4
}

local bytes_sps2 = {
    0x00, 0x00, 0x01, 0x67, 0x64, 0x00, 0x1F, 0xAC,
    0x72, 0x84, 0x40, 0xA0, 0x2F, 0xF9, 0x70, 0x11,
    0x00, 0x00, 0x03, 0x00, 0x01, 0x00, 0x00, 0x03,
    0x00, 0x3C, 0x0F, 0x18, 0x31, 0x84, 0x60, 0x00

--[[
                            0x64, 0x00, 0x1f, 0xac,
    0x72, 0x84, 0x40, 0xa0, 0x2f, 0xf9, 0x70, 0x11,
    0x00, 0x00,       0x00, 0x01, 0x00, 0x00,
    0x00, 0x3c, 0x0f, 0x18, 0x31, 0x84, 0x60, 0x00
--]]
}

local bytes_pps = {
    0x00, 0x00, 0x01, 0x68, 0xE8, 0x43, 0x94, 0xB2,
    0x2C
}

local bytes1= {
    0x00, 0x00, 0x00, 0x01, 0x67, 0xCD, 0x00, 0x00, 0x01, 0x65, 0x34, 0x45, 0x78
    --0x00, 0x00, 0x00, 0x01, 0xAB
}

local function test_nalu_unshell(data)

    local str = ""
    for _, v in ipairs(data) do
        str = str .. string.pack("B", v)
    end

    local len, data2 = bi.nalu_unshell(str, #str)
    bi.log(string.format("nalu_unshell len:%d", len))
    bi.dump( data2, len )
end


--test_find_nalu(bytes1)
--test_nalu_unshell(bytes_sps2)
--test_find_nalu(bytes_sps)
--test_find_nalu(bytes_sps2)
--test_find_nalu(bytes_pps)
test_find_nalu_from_file()

